---
- name: Install Cloudflare Tunnel
  hosts: monitoring
  become: true

  vars:
    tunnel_name: "devops-bootcamp-project"
    tunnel_token: "eyJhIjoiMDFhMTM1YWI0MzYzNjhlYzU0ZjU4ODZhOTJlNzIzZTUiLCJ0IjoiNzJmODE2MWItZmY4My00ZmU5LWI4OTktZmUxM2UyMTgxNmIzIiwicyI6Ik5qRXdaRFJoWlRBdE1qSmpPUzAwTkdOakxXSXpOR0l0WVdSalpqa3dOV0ZtWkRrMiJ9"  # ← Replace with your token
    grafana_domain: "grafana.muma-tech.com"  # ← Your domain

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Download and install cloudflared (direct deb)
      block:
        - name: Download latest cloudflared deb
          get_url:
            url: https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            dest: /tmp/cloudflared.deb
            mode: '0644'

        - name: Install cloudflared
          apt:
            deb: /tmp/cloudflared.deb
          notify: restart cloudflared

    - name: Create cloudflared config dir
      file:
        path: /etc/cloudflared
        state: directory

    - name: Create tunnel config
      template:
        src: ../templates/config.yml.j2
        dest: /etc/cloudflared/config.yml
        mode: '0644'
      notify: restart cloudflared

    - name: Create cloudflared systemd service (token mode)
      copy:
        content: |
          [Unit]
          Description=Cloudflare Tunnel
          After=network.target docker.service
          Wants=network.target docker.service

          [Service]
          Type=simple
          ExecStart=/usr/bin/cloudflared tunnel --token {{ tunnel_token }} --name {{ tunnel_name }} --loglevel info
          Restart=on-failure
          RestartSec=5s
          User=root

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/cloudflared.service
        mode: '0644'
      notify:
        - reload systemd
        - restart cloudflared

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart cloudflared
      systemd:
        name: cloudflared
        state: restarted
